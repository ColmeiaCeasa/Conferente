<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confer√™ncia Digital Colm√©ia</title>
  <style>
    html, body { 
      margin: 0; padding: 0;
      height: 100%; overflow: hidden;
      font-family: 'Segoe UI', sans-serif; 
      background: #f0f2f5; color: #333;
    }
    
    /* Cabe√ßalho Fixo */
    .header-fixed { 
      position: fixed; top: 0; width: 100%;
      background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      z-index: 100; padding: 10px 0;
    }
    .container { max-width: 500px; margin: auto; padding: 0 15px; }
    
    .logo-container { text-align: center; margin-bottom: 5px; }
    .logo-container img { max-height: 80px; width: auto; } /* Logo aumentada */

    h1 { 
      color: #075E54; font-size: 18px; text-align: center; 
      margin: 5px 0 10px 0; font-weight: bold; 
    }

    .header-info { background: #f9f9f9; padding: 8px; border-radius: 8px; border: 1px solid #eee; font-size: 13px; }
    
    select, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    
    .search-container { position: relative; margin-top: 8px; }
    .search-input { 
      width: 100%; padding: 10px 35px 10px 10px; border-radius: 6px; 
      border: 1px solid #25D366; font-size: 16px; box-sizing: border-box;
    }
    .btn-clear-search {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: #ccc; color: white; border: none; border-radius: 50%;
      width: 22px; height: 22px; font-size: 12px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* Ajuste da altura para n√£o cobrir os produtos devido ao t√≠tulo novo */
    .scrollable-content { 
      position: absolute;
      top: 260px; 
      bottom: 90px; 
      left: 0; right: 0;
      overflow-y: auto; 
      padding: 10px 0;
    }

    .item-row { 
      background: white; border-radius: 8px; margin-bottom: 8px; padding: 12px; 
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: background 0.2s;
    }

    .item-preenchido { background: #e8f5e9 !important; border: 1px solid #25D366; }

    .inputs-group { display: flex; gap: 8px; }
    .input-box { display: flex; flex-direction: column; align-items: center; }
    .input-box label { font-size: 10px; color: #888; text-transform: uppercase; }
    input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 16px; }

    .footer-fixed { 
      position: fixed; bottom: 0; width: 100%;
      background: white; border-top: 1px solid #ddd;
      padding: 15px 0; z-index: 100;
    }
    .btn-enviar { 
      width: 90%; max-width: 470px; display: block; margin: auto; 
      padding: 16px; background: #25D366; color: white; 
      border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;
    }

    .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; max-height: 70vh; overflow-y: auto; }
    .revisao-texto { white-space: pre-wrap; background: #f4f4f4; padding: 12px; border-radius: 6px; font-size: 13px; margin: 15px 0; border: 1px solid #ddd; }
    .modal-btns { display: flex; gap: 10px; }
    .btn-confirmar { flex: 2; background: #25D366; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; }
    .btn-corrigir { flex: 1; background: #666; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; }
  </style>
</head>
<body>

<div class="header-fixed">
  <div class="container">
    <div class="logo-container">
      <img src="https://i.postimg.cc/Mp43sV46/LOGO-COLMEIA.png" alt="Logo Colm√©ia">
    </div>

    <h1>Confer√™ncia Digital Colm√©ia</h1>

    <div class="header-info">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span><b>üìÖ</b> <span id="dataHoraAtual"></span></span>
        <select id="selectConferente" style="width: 55%; padding: 5px; font-size: 13px;">
          <option value="">üë§ Conferente...</option>
        </select>
      </div>
      
      <div class="search-container">
        <input type="text" id="inputBusca" class="search-input" placeholder="üîç Buscar produto ou c√≥digo..." onkeyup="filtrarProdutos()">
        <button class="btn-clear-search" onclick="limparBusca()">‚úï</button>
      </div>
    </div>
  </div>
</div>

<div class="scrollable-content">
  <div class="container">
    <div id="listaProdutos"><p style="text-align:center;">Buscando produtos...</p></div>
    
    <div style="margin: 15px 0;">
      <label style="font-weight:bold; font-size:14px;">üìù Observa√ß√µes:</label>
      <textarea id="obsGeral" rows="2" placeholder="Notas da carga..."></textarea>
    </div>
  </div>
</div>

<div class="footer-fixed">
  <button class="btn-enviar" onclick="abrirRevisao()">üìã Revisar e Enviar</button>
</div>

<div id="modalRevisao" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0">Revisar Relat√≥rio</h3>
    <div id="corpoRevisao" class="revisao-texto"></div>
    <div class="modal-btns">
      <button class="btn-corrigir" onclick="fecharRevisao()">Alterar</button>
      <button class="btn-confirmar" onclick="confirmarEEnviar()">Confirmar</button>
    </div>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhTl3okNtfIJgyjdZl34x0Kw8nssJfOC7dqChaIsV1GIZx3j5iU5vZhYLe1WryQ3L4gA/exec";
  const MEU_WHATSAPP = "5516991251990";

  let dadosProdutos = [];
  let mensagemFinal = "";

  function atualizarDataHora() {
    const agora = new Date();
    const formato = agora.toLocaleDateString('pt-BR') + " " + agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
    document.getElementById('dataHoraAtual').innerText = formato;
  }
  
  atualizarDataHora();
  setInterval(atualizarDataHora, 60000);

  function checkInput(index) {
    const qtd = document.getElementById(`qtd-${index}`).value;
    const qbr = document.getElementById(`qbr-${index}`).value;
    const row = document.getElementById(`row-${index}`);
    row.classList.toggle('item-preenchido', (qtd > 0 || qbr > 0));
  }

  function filtrarProdutos() {
    const termo = document.getElementById('inputBusca').value.toLowerCase();
    const rows = document.getElementsByClassName('item-row');
    Array.from(rows).forEach(row => {
      const texto = row.innerText.toLowerCase();
      row.style.display = texto.includes(termo) ? "flex" : "none";
    });
  }

  function limparBusca() {
    const input = document.getElementById('inputBusca');
    input.value = "";
    filtrarProdutos();
    input.focus();
  }

  async function carregarDados() {
    try {
      const response = await fetch(SCRIPT_URL + "?get=produtos");
      const data = await response.json();
      const select = document.getElementById('selectConferente');
      data.conferentes.forEach(nome => {
        let opt = document.createElement('option');
        opt.value = nome; opt.text = nome; select.appendChild(opt);
      });
      dadosProdutos = data.produtos;
      const lista = document.getElementById('listaProdutos');
      lista.innerHTML = '';
      dadosProdutos.forEach((p, index) => {
        lista.innerHTML += `
          <div class="item-row" id="row-${index}">
            <div style="flex:1"><b>${p.codigo}</b><br><small>${p.nome}</small></div>
            <div class="inputs-group">
              <div class="input-box"><label>Qtd</label><input type="number" id="qtd-${index}" oninput="checkInput(${index})" placeholder="0"></div>
              <div class="input-box"><label>Qbra</label><input type="number" id="qbr-${index}" oninput="checkInput(${index})" placeholder="0"></div>
            </div>
          </div>`;
      });
    } catch (e) { document.getElementById('listaProdutos').innerText = "Erro ao carregar."; }
  }

  function abrirRevisao() {
    const conferente = document.getElementById('selectConferente').value;
    const obs = document.getElementById('obsGeral').value;
    if (!conferente) return alert("Selecione o conferente!");

    const dataHoraFinal = document.getElementById('dataHoraAtual').innerText;

    let msg = `*RELAT√ìRIO DE CONFER√äNCIA*\n`;
    msg += `üè¢ *CONFER√äNCIA DIGITAL COLM√âIA*\n`;
    msg += `üìÖ Data/Hora: ${dataHoraFinal}\n`;
    msg += `üë§ Conferente: ${conferente}\n`;
    msg += `----------------------------\n\n`;

    let temDados = false;
    dadosProdutos.forEach((p, index) => {
      const q = document.getElementById(`qtd-${index}`).value || 0;
      const b = document.getElementById(`qbr-${index}`).value || 0;
      if (q > 0 || b > 0) {
        temDados = true;
        msg += `üì¶ *${p.nome}*\nQtd: ${q} | Qbra: ${b}\n\n`;
      }
    });

    if (obs) msg += `üìù *Obs:* ${obs}\n`;
    if (!temDados) return alert("Preencha ao menos um item!");

    mensagemFinal = msg;
    document.getElementById('corpoRevisao').innerText = msg;
    document.getElementById('modalRevisao').style.display = 'block';
  }

  function fecharRevisao() { document.getElementById('modalRevisao').style.display = 'none'; }

  function limparFormulario() {
    dadosProdutos.forEach((p, index) => {
      const q = document.getElementById(`qtd-${index}`);
      const b = document.getElementById(`qbr-${index}`);
      if(q) q.value = "";
      if(b) b.value = "";
      const row = document.getElementById(`row-${index}`);
      if(row) {
        row.classList.remove('item-preenchido');
        row.style.display = "flex";
      }
    });
    document.getElementById('obsGeral').value = "";
    document.getElementById('inputBusca').value = "";
    document.getElementById('selectConferente').value = "";
    document.querySelector('.scrollable-content').scrollTop = 0;
  }

  function confirmarEEnviar() {
    const url = `https://api.whatsapp.com/send?phone=${MEU_WHATSAPP}&text=${encodeURIComponent(mensagemFinal)}`;
    window.open(url, '_blank');
    fecharRevisao();
    setTimeout(limparFormulario, 1500); 
  }

  carregarDados();
</script>

</body>
</html>
